# Build Directory

This directory contains scripts and tools for maintaining the `gdalcli` package.

## Files

- **`generate_gdal_api.R`** - Master script that auto-generates 80+ R wrapper functions from GDAL's JSON API specification

## How It Works

The `generate_gdal_api.R` script:

1. **Crawls GDAL's JSON API** using `gdal --json-usage` to discover all available commands and their arguments
2. **Generates R functions** with properly validated arguments matching GDAL's specifications
3. **Enriches documentation** by:
   - Web-scraping official GDAL documentation from gdal.org
   - Extracting descriptions, parameter explanations, and code examples
   - Creating @family tags for automatic pkgdown cross-linking
   - Caching results to avoid repeated HTTP requests
4. **Generates roxygen2 blocks** with complete parameter documentation
5. **Writes R files** to `R/gdal*.R` with proper formatting and comments

## Usage

### Using the Makefile (Recommended)

From the package root directory:

```bash
# Regeneration with web enrichment
make regen

# Clean cache and regenerate
make regen-clean

# Full development workflow
make dev        # regen + docs + check-man
make all        # regen + docs + check

# View all available targets
make help
```

### Running Directly

```bash
# Without documentation enrichment (fast)
SKIP_DOC_ENRICHMENT=true Rscript build/generate_gdal_api.R

# With documentation enrichment (slower)
Rscript build/generate_gdal_api.R
```

## Documentation Enrichment

The script uses scrapes the official GDAL documentation to enrich auto-generated function documentation:

1. **URL Construction**: Maps command paths like `c("gdal", "raster", "info")` to documentation URLs
2. **HTML Parsing**: Extracts descriptions, parameter docs, and examples from HTML
3. **Caching**: Stores scraped content in `.gdal_doc_cache/` using hashed filenames to avoid repeated requests
4. **Fallback**: Falls back to JSON API descriptions if web content is unavailable

### Performance

- **First run**: ~2-3 minutes (web scraping + file generation)
- **Subsequent runs**: ~30 seconds (uses cache)
- **Fast mode** (`SKIP_DOC_ENRICHMENT=true`): ~30 seconds (no web scraping)

### Clearing the Cache

To force re-scraping of documentation:

```bash
make regen-clean
# or manually:
rm -rf .gdal_doc_cache/
```

## Generated Files

The script generates 80+ auto-generated R files from GDAL's JSON API:

- **Raster operations**: `gdal_raster_*.R`
- **Vector operations**: `gdal_vector_*.R`
- **Multidimensional data**: `gdal_mdim_*.R`
- **VSI/cloud storage**: `gdal_vsi_*.R`
- **Driver-specific**: `gdal_driver_*.R`

Each file:

- Contains a single exported function
- Includes roxygen2 documentation with enriched parameter descriptions
- References `build/generate_gdal_api.R` in the header
- Is regenerated on each run (never edit directly)

## Core vs Generated Files

The `R/` directory has two types of files:

1. **Core files** (prefix: `core-*`)
   - Manually maintained infrastructure
   - Hand-written by developers
   - Examples: `core-gdal_job.R`, `core-gdal_run.R`, `core-gdal_auth_helpers.R`

2. **Generated files** (no prefix)
   - Auto-generated by this script
   - Never edit directly
   - Regenerate after updating GDAL version

## GDAL Version Requirements

### Minimum GDAL Version

- **GDAL >= 3.11**: All core functionality and 80+ CLI operations
- **GDAL >= 3.12**: Additional algorithms and GDALG format write support

### GDALG Format Feature Support

The GDALG format (JSON-based pipeline files) has different capabilities depending on GDAL version:

- **GDAL 3.11+**: Read GDALG files, write using custom JSON implementation, read-only GDALG format driver
- **GDAL 3.12+**: Full GDALG format driver support, native driver for writing GDALG files, enhanced pipeline save/load functions

### Checking Your GDAL Version

To verify your installed GDAL version:

```bash
gdal --version
```

In R:

```r
library(gdalcli)
gdal_check_version("3.12")  # Check if GDAL >= 3.12
gdal_capabilities()         # List GDAL capabilities
```

## Next Steps

After regeneration:

1. **Update documentation**:

```bash
make docs        # Generates man/ .Rd files
```

1. **Validate**:

```bash
make check-man   # Check man page validation
make check       # Full R CMD check
```

1. **Install locally**:

```bash
make install     # Install package locally
```

## Troubleshooting

### "GDAL command not found"

Ensure GDAL >= 3.11 is installed and in your PATH:

```bash
gdal --version
```

### "Failed to parse JSON"

Some GDAL versions may have JSON parsing issues. Check GDAL output:

```bash
gdal --json-usage
```

### Web scraping errors

If documentation enrichment fails, the script falls back to basic descriptions. Check your internet connection and GDAL documentation server status.

## Environment Variables

- `SKIP_DOC_ENRICHMENT=true` - Skip web scraping enrichment (fast mode)
- `GDAL_*` - Standard GDAL environment variables are passed through to subprocess

## License

Auto-generated code follows the same license as the gdalcli package (MIT).
