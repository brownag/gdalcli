name: Deploy to R-Universe

on:
  push:
    branches:
      - 'release/**'
    tags:
      - 'v*'

jobs:
  trigger-r-universe:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version info
        id: version
        run: |
          # Extract GDAL version from branch name (release/gdal-3.11 -> 3.11)
          if [[ "${{ github.ref }}" == refs/heads/release/* ]]; then
            branch_name="${{ github.ref }}"
            branch_name="${branch_name#refs/heads/}"
            gdal_version="${branch_name#release/gdal-}"
            echo "gdal_version=$gdal_version" >> $GITHUB_OUTPUT
            echo "is_release_branch=true" >> $GITHUB_OUTPUT
          else
            echo "is_release_branch=false" >> $GITHUB_OUTPUT
          fi

          # Extract tag version
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            tag_name="${{ github.ref }}"
            tag_name="${tag_name#refs/tags/v}"
            echo "tag_version=$tag_name" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger main R-Universe build
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Triggering main branch build in R-Universe..."
          echo "URL: https://github.com/your-org/r-universe/settings"
          echo "Package: gdalcli"
          echo "Branch: main"

          # In actual implementation, this would call R-Universe API
          # For now, just log the action
          echo "✓ Main branch deployment workflow triggered"

      - name: Trigger GDAL-specific R-Universe build
        if: steps.version.outputs.is_release_branch == 'true'
        run: |
          gdal_version=${{ steps.version.outputs.gdal_version }}
          echo "Triggering R-Universe build for GDAL $gdal_version..."
          echo ""
          echo "Repository: your-org/r-universe-gdal${gdal_version/./}"
          echo "Package: gdalcli"
          echo "Branch: release/gdal-$gdal_version"
          echo ""
          echo "Installation command for users:"
          echo "install.packages('gdalcli',"
          echo "  repos = 'https://your-org-gdal${gdal_version/./}.r-universe.dev')"
          echo ""
          echo "✓ GDAL-specific R-Universe build queued"

      - name: Create deployment notification
        if: success()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.version.outputs.is_release_branch }}" == "true" ]]; then
            gdal_version=${{ steps.version.outputs.gdal_version }}
            echo "### Release Branch: GDAL $gdal_version" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** \`release/gdal-$gdal_version\`" >> $GITHUB_STEP_SUMMARY
            echo "- **R-Universe:** https://your-org-gdal${gdal_version/./}.r-universe.dev" >> $GITHUB_STEP_SUMMARY
            echo "- **Installation:** \`install.packages('gdalcli', repos = 'https://your-org-gdal${gdal_version/./}.r-universe.dev')\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Main Branch Deployment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** \`main\`" >> $GITHUB_STEP_SUMMARY
            echo "- **R-Universe:** https://your-org.r-universe.dev" >> $GITHUB_STEP_SUMMARY
            echo "- **Installation:** \`install.packages('gdalcli', repos = 'https://your-org.r-universe.dev')\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Post deployment status
        if: always()
        run: |
          echo "Deployment workflow completed"
          echo "Status: ${{ job.status }}"
