name: Generate Version-Pinned Release Branch

on:
  workflow_dispatch:
    inputs:
      gdal_version_short:
        description: 'GDAL version short (e.g., 3.11, 3.12)'
        required: true
        type: string
      gdal_version_full:
        description: 'GDAL version full (e.g., 3.11.1)'
        required: true
        type: string

jobs:
  generate-release:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/osgeo/gdal:ubuntu-full-${{ inputs.gdal_version_full }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R environment
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - name: Install system dependencies
        run: |
          apt-get update && apt-get install -y \
            libxml2-dev \
            libcurl4-openssl-dev \
            libssl-dev

      - name: Install R dependencies
        run: |
          Rscript -e "
            install.packages(c(
              'processx', 'jsonlite', 'glue', 'rvest', 'httr', 'xml2',
              'digest', 'R6', 'rlang', 'cli', 'gdalraster', 'roxygen2',
              'devtools'
            ))
          "

      - name: Verify GDAL version
        run: |
          echo "Verifying GDAL version..."
          gdal --version

      - name: Generate static API
        run: |
          echo "Generating static API for GDAL ${{ inputs.gdal_version_full }}..."
          cd /github/workspace
          Rscript build/generate_gdal_api.R
          echo "Static API generation complete"

      - name: Generate documentation
        run: |
          echo "Generating roxygen2 documentation..."
          Rscript -e "roxygen2::roxygenise()"
          echo "Documentation generation complete"

      - name: Create version metadata
        run: |
          Rscript -e "
            version_info <- list(
              gdal_version = '${{ inputs.gdal_version_full }}',
              release_date = Sys.Date(),
              api_generation_date = Sys.Date(),
              command_count = length(list.files('R', '^gdal_.*\\.R$')),
              groups = c('raster', 'vector', 'mdim', 'vsi', 'driver'),
              branch = 'release/gdal-${{ inputs.gdal_version_short }}',
              notes = paste('Pre-computed API for GDAL',
                           '${{ inputs.gdal_version_short }}.x series')
            )
            jsonlite::write_json(
              version_info,
              'inst/GDAL_VERSION_INFO.json',
              pretty = TRUE
            )
          "

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push release branch
        run: |
          branch_name="release/gdal-${{ inputs.gdal_version_short }}"
          echo "Creating branch: $branch_name"
          git checkout -b $branch_name

          # Update DESCRIPTION
          Rscript -e "
            desc <- readLines('DESCRIPTION')
            # Update Version
            version_line <- grep('^Version:', desc)
            desc[version_line] <- 'Version: 0.2.0+gdal${{ inputs.gdal_version_short }}'

            # Update SystemRequirements
            sys_req_line <- grep('^SystemRequirements:', desc)
            desc[sys_req_line] <- 'SystemRequirements: GDAL (${{ inputs.gdal_version_full }})'

            writeLines(desc, 'DESCRIPTION')
          "

          # Add and commit
          git add R/gdal_*.R man/*.Rd DESCRIPTION inst/GDAL_VERSION_INFO.json
          git commit -m "Release: Pre-computed API for GDAL ${{ inputs.gdal_version_full }}

- Generated static API functions for this GDAL version
- Enriched documentation from gdal.org
- Version-pinned for GDAL ${{ inputs.gdal_version_short }}.x series
- Pre-seeded dynamic API cache for fast first load

ðŸ¤– Generated by GitHub Actions"

          git push origin $branch_name
          echo "Branch $branch_name pushed successfully"

      - name: Create release tag
        run: |
          tag_name="v0.2.0-gdal${{ inputs.gdal_version_full }}"
          echo "Creating tag: $tag_name"
          git tag -a $tag_name -m "Release for GDAL ${{ inputs.gdal_version_full }}"
          git push origin $tag_name
          echo "Tag $tag_name pushed successfully"

      - name: Summary
        run: |
          echo "âœ… Release branch created successfully!"
          echo ""
          echo "Branch: release/gdal-${{ inputs.gdal_version_short }}"
          echo "Tag: v0.2.0-gdal${{ inputs.gdal_version_full }}"
          echo "GDAL Version: ${{ inputs.gdal_version_full }}"
          echo ""
          echo "Next steps:"
          echo "1. Configure R-Universe for this branch"
          echo "2. Test installation: install.packages('gdalcli', repos='...')"
          echo "3. Announce release"
