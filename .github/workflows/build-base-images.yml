---
# Build GDAL Base Images
#
# Manual workflow to build and publish reusable GDAL base images with
# R packages pre-installed. These base images can be used by the dynamic
# build workflow to avoid recompiling GDAL and reinstalling R packages.
#
# This workflow should be run manually when:
# - New GDAL versions are released
# - R package dependencies change significantly
# - Base image updates are needed
# - Dockerfile changes require cache invalidation (increment cache_version)
#
name: Build GDAL Base Images

on:
  workflow_dispatch:
    inputs:
      push_images:
        description: 'Push images to GitHub Container Registry?'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      disable_cache:
        description: 'Disable Docker layer caching to force fresh rebuild?'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      cache_version:
        description: 'Cache version (increment to invalidate existing cache)'
        required: false
        default: 'v1'
        type: string

permissions:
  contents: read
  packages: write

jobs:
  build-base-images:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        gdal_version: [3.11.4, 3.12.0]
        architecture: [amd64, arm64]
        exclude:
          # Exclude arm64 for now as it's slower and less tested
          - architecture: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event.inputs.push_images == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract GDAL short version
        id: parse
        run: |
          VERSION="${{ matrix.gdal_version }}"
          SHORT=$(echo "$VERSION" | cut -d. -f1-2)
          echo "gdal_short=$SHORT" >> $GITHUB_OUTPUT

      - name: Check OSGeo GDAL image availability
        id: check-image
        run: |
          GDAL_VERSION="${{ matrix.gdal_version }}"
          ARCH="${{ matrix.architecture }}"

          # Try different tag formats in order of preference
          if [ "$ARCH" = "arm64" ]; then
            TAGS_TO_TRY=(
              "ubuntu-small-arm64-${GDAL_VERSION}"
              "ubuntu-small-${GDAL_VERSION}"
              "ubuntu-small-arm64-latest"
              "ubuntu-small-latest"
              "ubuntu-small-arm64"
              "ubuntu-small"
              "latest"
            )
          else
            TAGS_TO_TRY=(
              "ubuntu-small-amd64-${GDAL_VERSION}"
              "ubuntu-small-${GDAL_VERSION}"
              "ubuntu-small-amd64-latest"
              "ubuntu-small-latest"
              "ubuntu-small-amd64"
              "ubuntu-small"
              "latest"
            )
          fi

          SELECTED_TAG=""
          for TAG in "${TAGS_TO_TRY[@]}"; do
            IMAGE_TAG="ghcr.io/osgeo/gdal:${TAG}"
            echo "Checking: $IMAGE_TAG"

            if docker buildx imagetools inspect "$IMAGE_TAG" >/dev/null 2>&1; then
              echo "Found OSGeo GDAL image: $IMAGE_TAG"
              SELECTED_TAG="$TAG"
              break
            fi
          done

          if [ -z "$SELECTED_TAG" ]; then
            echo "No suitable OSGeo GDAL image found for version ${GDAL_VERSION} (${ARCH})"
            exit 1
          fi

          echo "selected_gdal_image_tag=$SELECTED_TAG" >> $GITHUB_OUTPUT

      - name: Build and push GDAL base image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .github/dockerfiles/Dockerfile.template
          target: gdal-base
          build-args: |
            GDAL_BUILD_MODE=osgeo
            GDAL_VERSION=${{ matrix.gdal_version }}
            GDAL_RELEASE_TYPE=tagged
            GDAL_IMAGE_TAG=${{ steps.check-image.outputs.selected_gdal_image_tag }}
            R_VERSION=latest
            PACKAGE_VERSION=0.2.0
          tags: |
            ghcr.io/${{ github.repository }}:base-gdal-${{ matrix.gdal_version }}-${{ matrix.architecture }}
            ghcr.io/${{ github.repository }}:base-gdal-${{ steps.parse.outputs.gdal_short }}-${{ matrix.architecture }}
            ${{ matrix.architecture == 'amd64' && format('ghcr.io/{0}:gdal-{1}-latest', github.repository, matrix.gdal_version) || '' }}
          platforms: linux/${{ matrix.architecture }}
          cache-from: ${{ github.event.inputs.disable_cache == 'false' && format('type=gha,scope=gdal-base-{0}-{1}-{2}', matrix.gdal_version, matrix.architecture, github.event.inputs.cache_version) || '' }}
          cache-to: ${{ github.event.inputs.disable_cache == 'false' && format('type=gha,mode=max,scope=gdal-base-{0}-{1}-{2}', matrix.gdal_version, matrix.architecture, github.event.inputs.cache_version) || '' }}
          push: ${{ github.event.inputs.push_images == 'true' }}
          provenance: false
          sbom: false

      - name: Generate build summary
        if: always()
        run: |
          echo "## Base Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| GDAL Version | ${{ matrix.gdal_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | ${{ matrix.architecture }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Base Image | ghcr.io/osgeo/gdal:${{ steps.check-image.outputs.selected_gdal_image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target Image | ghcr.io/${{ github.repository }}:base-gdal-${{ matrix.gdal_version }}-${{ matrix.architecture }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pushed | ${{ github.event.inputs.push_images }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Disabled | ${{ github.event.inputs.disable_cache }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Version | ${{ github.event.inputs.cache_version }} |" >> $GITHUB_STEP_SUMMARY