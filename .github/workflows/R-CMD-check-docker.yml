name: R-CMD-check (Docker)

on:
  push:
    branches: [main, master]
  pull_request:

permissions: read-all

jobs:
  determine-gdal-version:
    runs-on: ubuntu-latest
    permissions:
      packages: read
    outputs:
      latest-gdal: ${{ steps.version.outputs.latest }}
    steps:
      - name: Query GHCR for latest deps image
        id: version
        run: |
          LATEST=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/users/${{ github.repository_owner }}/packages/container/gdalcli/versions" | \
            jq -r '.[].metadata.container.tags[] | select(startswith("deps-gdal-")) | gsub("deps-gdal-|-amd64"; "") | select(test("^[0-9]+\\.[0-9]+\\.[0-9]+$"))' | \
            sort -V | tail -1)
          
          if [ -z "$LATEST" ]; then
            echo "ERROR: Could not find any deps-gdal images in GHCR"
            exit 1
          fi
          
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "Found latest GDAL version in GHCR: $LATEST"
          
  check:
    needs: determine-gdal-version
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - r-version: 'release'
            gdal-version: '3.11.4'
          - r-version: 'devel'
            gdal-version: ${{ needs.determine-gdal-version.outputs.latest-gdal }}

    container:
      image: ghcr.io/${{ github.repository }}:deps-gdal-${{ matrix.gdal-version }}-amd64
      env:
        R_VERSION: ${{ matrix.r-version }}

    name: R ${{ matrix.r-version }} / GDAL ${{ matrix.gdal-version }}

    steps:
      - uses: actions/checkout@v4

      - name: Verify GDAL environment
        run: |
          echo "=== System Info ===" 
          uname -a
          echo "=== GDAL ===" 
          gdal --version
          which gdal
          echo "=== R ===" 
          R --version | head -6
          echo "=== R packages ===" 
          Rscript -e "sessionInfo()"

      - name: Verify development dependencies
        run: |
          Rscript -e "if (!require('devtools', quietly=TRUE)) stop('devtools not installed in base image')"

      - name: Generate GDAL API
        run: |
          Rscript build/generate_gdal_api.R

      - name: Document package
        run: |
          Rscript -e "roxygen2::roxygenise()"

      - name: Run R CMD check
        run: |
          export LANG=en_US.UTF-8
          Rscript -e "devtools::check(args = c('--no-manual'))"

      - name: Install package
        run: |
          Rscript -e "devtools::install()"

      - name: Verify package installation
        run: |
          Rscript -e "library(gdalcli); cat('gdalcli loaded successfully\n'); print(gdal_capabilities())"

      - name: Run package tests
        run: |
          Rscript -e "devtools::test()"

      - name: Generate test summary
        if: always()
        run: |
          if [ -f gdalcli.Rcheck/tests/test_pipeline.Rout ]; then
            cat gdalcli.Rcheck/tests/test_pipeline.Rout
          fi

      - name: Upload check results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: check-results-${{ matrix.r-version }}
          path: gdalcli.Rcheck/
          retention-days: 7
