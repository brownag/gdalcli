name: Test Multiple GDAL Versions

on:
  push:
    branches: [main, 'release/**']
  pull_request:
    branches: [main, 'release/**']

jobs:
  test-gdal-versions:
    strategy:
      fail-fast: false
      matrix:
        gdal-version: ['3.11.1', '3.12.0']
        r-version: ['release']
        include:
          - gdal-version: '3.11.1'
            container-image: 'ghcr.io/osgeo/gdal:ubuntu-full-3.11.1'
          - gdal-version: '3.12.0'
            container-image: 'ghcr.io/osgeo/gdal:ubuntu-full-3.12.0'

    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.container-image }}

    name: Test on GDAL ${{ matrix.gdal-version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      - name: Install system dependencies
        run: |
          apt-get update && apt-get install -y \
            libxml2-dev \
            libcurl4-openssl-dev \
            libssl-dev

      - name: Install R dependencies
        run: |
          Rscript -e "
            install.packages(c(
              'devtools', 'testthat', 'roxygen2',
              'rlang', 'cli', 'processx', 'jsonlite',
              'digest', 'rvest', 'httr', 'xml2',
              'gdalraster', 'R6'
            ), repos = 'https://cran.r-project.org')
          "

      - name: Verify GDAL installation
        run: |
          echo "GDAL version:"
          gdal --version
          echo ""
          echo "gdalraster installation:"
          Rscript -e "library(gdalraster); gdalraster::gdal_version()"

      - name: Build package
        run: |
          Rscript -e "devtools::load_all()"

      - name: Run tests
        run: |
          Rscript -e "devtools::test()"

      - name: Check package
        run: |
          Rscript -e "devtools::check()" || true

      - name: Test dynamic API initialization
        run: |
          Rscript -e "
            library(gdalcli)
            cat('Testing dynamic API...\n')

            # Check if gdal object exists
            if (exists('gdal')) {
              cat('✓ gdal object initialized\n')
              cat('  Groups:', paste(gdal\$get_groups(), collapse=', '), '\n')
            } else {
              cat('⚠ gdal object not found (gdalraster may not be available)\n')
            }
          "

      - name: Test version check
        run: |
          Rscript -e "
            library(gdalcli)
            if (exists('gdal_version_check')) {
              result <- gdal_version_check()
              cat('Version check:', result\$message, '\n')
            }
          "

      - name: Generate test report
        if: always()
        run: |
          echo "Test Summary for GDAL ${{ matrix.gdal-version }}"
          echo "=========================================="
          gdal --version
          Rscript -e "sessionInfo()"
