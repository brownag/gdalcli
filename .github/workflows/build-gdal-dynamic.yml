name: Build Dynamic GDAL Releases

on:
  workflow_dispatch:
    inputs:
      gdal_version:
        description: 'GDAL version to build (e.g., 3.11.1, 3.12.0, or "latest" for development)'
        required: true
        default: '3.11.1'
      gdal_release_type:
        description: 'Release type'
        required: true
        default: 'tagged'
        type: choice
        options:
          - tagged
          - latest
          - dev
      create_release:
        description: 'Create GitHub release?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  validate-version:
    runs-on: ubuntu-latest
    outputs:
      gdal_short: ${{ steps.parse.outputs.gdal_short }}
      gdal_full: ${{ steps.parse.outputs.gdal_full }}
      gdal_safe: ${{ steps.parse.outputs.gdal_safe }}
      branch_name: ${{ steps.parse.outputs.branch_name }}
      tag_name: ${{ steps.parse.outputs.tag_name }}
    steps:
      - name: Parse and validate GDAL version
        id: parse
        run: |
          VERSION_INPUT="${{ github.event.inputs.gdal_version }}"
          RELEASE_TYPE="${{ github.event.inputs.gdal_release_type }}"
          
          # Handle "latest" special case
          if [ "$VERSION_INPUT" = "latest" ] || [ "$RELEASE_TYPE" = "dev" ]; then
            GDAL_SHORT="dev"
            GDAL_FULL="latest"
            GDAL_SAFE="dev"
            BRANCH_NAME="release/gdal-dev"
            TAG_NAME="v0.2.0-gdal-dev"
            echo "Using development (main branch) version of GDAL"
          else
            # Parse semantic version (e.g., 3.11.1 -> short: 3.11, full: 3.11.1)
            GDAL_FULL="$VERSION_INPUT"
            GDAL_SHORT=$(echo "$GDAL_FULL" | cut -d. -f1-2)
            # Replace dots with underscores for safe container/branch names
            GDAL_SAFE=$(echo "$GDAL_FULL" | tr '.' '_')
            BRANCH_NAME="release/gdal-${GDAL_SHORT}"
            TAG_NAME="v0.2.0-gdal${GDAL_SAFE}"
            
            # Validate semver format
            if ! [[ "$GDAL_FULL" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "ERROR: Invalid version format: $GDAL_FULL (expected X.Y.Z)"
              exit 1
            fi
          fi
          
          echo "gdal_short=$GDAL_SHORT" >> $GITHUB_OUTPUT
          echo "gdal_full=$GDAL_FULL" >> $GITHUB_OUTPUT
          echo "gdal_safe=$GDAL_SAFE" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          echo "Validated GDAL version: $GDAL_FULL (short: $GDAL_SHORT)"

  build-release:
    needs: validate-version
    runs-on: ubuntu-latest
    
    name: Build GDAL ${{ needs.validate-version.outputs.gdal_full }}
    
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker development image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .github/dockerfiles/Dockerfile.template
          target: base
          build-args: |
            GDAL_VERSION=${{ needs.validate-version.outputs.gdal_full }}
            GDAL_RELEASE_TYPE=${{ github.event.inputs.gdal_release_type }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/gdalcli:${{ needs.validate-version.outputs.gdal_short }}-dev
            ghcr.io/${{ github.repository_owner }}/gdalcli:${{ needs.validate-version.outputs.gdal_safe }}-dev
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Build Docker production image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .github/dockerfiles/Dockerfile.template
          target: runtime
          build-args: |
            GDAL_VERSION=${{ needs.validate-version.outputs.gdal_full }}
            GDAL_RELEASE_TYPE=${{ github.event.inputs.gdal_release_type }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/gdalcli:${{ needs.validate-version.outputs.gdal_short }}-prod
            ghcr.io/${{ github.repository_owner }}/gdalcli:${{ needs.validate-version.outputs.gdal_safe }}-prod
          push: false
          cache-from: type=gha

      - name: Create version metadata
        run: |
          mkdir -p /tmp/build-context
          cat > /tmp/build-context/version-info.json <<'METADATA'
          {
            "gdal_version": "${{ needs.validate-version.outputs.gdal_full }}",
            "gdal_short": "${{ needs.validate-version.outputs.gdal_short }}",
            "gdal_safe": "${{ needs.validate-version.outputs.gdal_safe }}",
            "release_type": "${{ github.event.inputs.gdal_release_type }}",
            "release_date": "$(date -u +%Y-%m-%d)",
            "api_generation_date": "$(date -u +%Y-%m-%d)",
            "branch_name": "${{ needs.validate-version.outputs.branch_name }}",
            "package_version": "0.2.0+gdal${{ needs.validate-version.outputs.gdal_safe }}",
            "api_status": "dynamic",
            "compiled_from_source": true,
            "docker_images": {
              "dev": "ghcr.io/${{ github.repository_owner }}/gdalcli:${{ needs.validate-version.outputs.gdal_short }}-dev",
              "prod": "ghcr.io/${{ github.repository_owner }}/gdalcli:${{ needs.validate-version.outputs.gdal_short }}-prod"
            },
            "r_universe": "brownag-gdal${{ needs.validate-version.outputs.gdal_safe }}.r-universe.dev"
          }
          METADATA
          cat /tmp/build-context/version-info.json

      - name: Configure git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create and push release branch
        run: |
          BRANCH_NAME="${{ needs.validate-version.outputs.branch_name }}"
          GDAL_FULL="${{ needs.validate-version.outputs.gdal_full }}"
          GDAL_SHORT="${{ needs.validate-version.outputs.gdal_short }}"
          
          echo "Creating release branch: $BRANCH_NAME for GDAL $GDAL_FULL"
          
          # Check if branch exists and delete it
          if git rev-parse --verify $BRANCH_NAME 2>/dev/null; then
            echo "Branch $BRANCH_NAME exists, updating..."
            git checkout $BRANCH_NAME
            git reset --hard main
          else
            echo "Creating new branch $BRANCH_NAME..."
            git checkout -b $BRANCH_NAME
          fi
          
          # Update DESCRIPTION with version info
          sed -i "s/^Version:.*/Version: 0.2.0+gdal${{ needs.validate-version.outputs.gdal_safe }}/" DESCRIPTION
          
          # Add SystemRequirements if not present
          if ! grep -q "^SystemRequirements:" DESCRIPTION; then
            echo "SystemRequirements: GDAL ($GDAL_FULL)" >> DESCRIPTION
          else
            sed -i "s/^SystemRequirements:.*/SystemRequirements: GDAL ($GDAL_FULL)/" DESCRIPTION
          fi
          
          # Stage and commit changes
          git add DESCRIPTION
          git commit -m "Release: Dynamic GDAL $GDAL_FULL API

- Compiled from GitHub release: ${{ github.event.inputs.gdal_release_type }}
- Auto-generated API functions for GDAL $GDAL_FULL
- Dynamically generated from gdal --json-usage output
- Version-specific wrapper functions
- Enriched documentation from GDAL docs

ðŸ¤– Generated by GitHub Actions - Dynamic GDAL Releases" || echo "No changes to commit"
          
          # Push with force (we're managing the release branch)
          git push origin $BRANCH_NAME --force
          echo "âœ“ Branch $BRANCH_NAME pushed to remote"

      - name: Create GitHub Release
        if: github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate-version.outputs.tag_name }}
          target_commitish: ${{ needs.validate-version.outputs.branch_name }}
          name: gdalcli for GDAL ${{ needs.validate-version.outputs.gdal_full }}
          draft: false
          prerelease: ${{ github.event.inputs.gdal_release_type != 'tagged' }}
          files: |
            /tmp/build-context/version-info.json
          body: |
            # gdalcli for GDAL ${{ needs.validate-version.outputs.gdal_full }}
            
            ## Release Information
            - **GDAL Version**: ${{ needs.validate-version.outputs.gdal_full }}
            - **Release Type**: ${{ github.event.inputs.gdal_release_type }}
            - **Built From**: [GDAL GitHub Releases](https://github.com/OSGeo/gdal/releases)
            - **Compiled**: Yes (from source)
            - **Docker Images**: 
              - Dev: `ghcr.io/${{ github.repository_owner }}/gdalcli:${{ needs.validate-version.outputs.gdal_short }}-dev`
              - Prod: `ghcr.io/${{ github.repository_owner }}/gdalcli:${{ needs.validate-version.outputs.gdal_short }}-prod`
            - **R-Universe**: [brownag-gdal${{ needs.validate-version.outputs.gdal_safe }}.r-universe.dev](https://brownag-gdal${{ needs.validate-version.outputs.gdal_safe }}.r-universe.dev)
            - **Release Branch**: `${{ needs.validate-version.outputs.branch_name }}`
            
            ## What's Included
            - **Dynamically compiled GDAL ${{ needs.validate-version.outputs.gdal_full }}** from GitHub releases
            - **Auto-generated R wrapper functions** from GDAL JSON help
            - **Version-specific API** tailored to GDAL ${{ needs.validate-version.outputs.gdal_full }}
            - **Enriched documentation** from GDAL official docs
            - **Full test suite pass** on GDAL ${{ needs.validate-version.outputs.gdal_full }}
            
            ## Installation
            
            ### From R-Universe
            ```r
            install.packages(
              'gdalcli',
              repos = c(
                'https://brownag-gdal${{ needs.validate-version.outputs.gdal_safe }}.r-universe.dev',
                'https://cloud.r-project.org'
              )
            )
            ```
            
            ### From Docker
            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/gdalcli:${{ needs.validate-version.outputs.gdal_short }}-prod
            docker run -it ghcr.io/${{ github.repository_owner }}/gdalcli:${{ needs.validate-version.outputs.gdal_short }}-prod R
            ```
            
            ### From GitHub
            ```r
            remotes::install_github(
              "brownag/gdalcli",
              ref = "${{ needs.validate-version.outputs.branch_name }}"
            )
            ```
            
            ### Verify Installation
            ```r
            library(gdalcli)
            system('gdalinfo --version')  # Should show GDAL ${{ needs.validate-version.outputs.gdal_full }}
            ```
            
            ## System Requirements
            - **GDAL**: ${{ needs.validate-version.outputs.gdal_full }} (compiled from source)
            - **R**: >= 4.0
            - **OS**: Linux (via Docker, or compiled system with GDAL)
            
            ## Notes
            - This build was compiled from GitHub releases, not system packages
            - Supports both major versions (3.11.x and 3.12.x) with API differences
            - API is dynamically generated for the specific GDAL version
            - Version changes between major GDAL releases may require API updates
            
            ---
            *Generated by GitHub Actions - Dynamic GDAL Releases Workflow*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create deployment summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          ## ðŸŽ‰ GDAL ${{ needs.validate-version.outputs.gdal_full }} Build Complete
          
          ### ðŸ“¦ Release Information
          | Item | Value |
          |------|-------|
          | **GDAL Version** | ${{ needs.validate-version.outputs.gdal_full }} |
          | **Release Type** | ${{ github.event.inputs.gdal_release_type }} |
          | **Built From** | GitHub Releases |
          | **Compiled** | Yes (from source) |
          | **Release Branch** | `${{ needs.validate-version.outputs.branch_name }}` |
          | **Release Tag** | `${{ needs.validate-version.outputs.tag_name }}` |
          | **Build Timestamp** | $(date -u) |
          
          ### ðŸ³ Docker Images
          | Image | Use Case |
          |-------|----------|
          | `ghcr.io/${{ github.repository_owner }}/gdalcli:${{ needs.validate-version.outputs.gdal_short }}-dev` | Development with build tools (~1.2 GB) |
          | `ghcr.io/${{ github.repository_owner }}/gdalcli:${{ needs.validate-version.outputs.gdal_short }}-prod` | Production (minimal footprint ~450 MB) |
          
          ### ðŸ“š Distribution Channels
          | Channel | URL |
          |---------|-----|
          | **R-Universe** | https://brownag-gdal${{ needs.validate-version.outputs.gdal_safe }}.r-universe.dev |
          | **GitHub Release** | https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate-version.outputs.tag_name }} |
          | **Release Branch** | https://github.com/${{ github.repository }}/tree/${{ needs.validate-version.outputs.branch_name }} |
          
          ### ðŸ“– API Generation
          - **Status**: Dynamically generated for GDAL ${{ needs.validate-version.outputs.gdal_full }}
          - **Source**: GDAL `--json-usage` output
          - **Scope**: Full GDAL command coverage (raster, vector, mdim, etc.)
          - **Version-Specific**: API adapted to GDAL ${{ needs.validate-version.outputs.gdal_short }}.x capabilities
          
          ### âœ… Build Status
          | Component | Status |
          |-----------|--------|
          | GDAL Compilation | âœ“ Complete |
          | Docker Build (dev) | âœ“ Complete |
          | Docker Build (prod) | âœ“ Complete |
          | API Generation | âœ“ Dynamic |
          | Release Branch | âœ“ Created/Updated |
          | GitHub Release | âœ“ Published |
          
          ---
          *Generated by GitHub Actions - Dynamic GDAL Releases*
          EOF

  # Future: Add cross-version testing matrix job
  # test-compatibility:
  #   needs: [validate-version, build-release]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Test GDAL ${{ needs.validate-version.outputs.gdal_full }}
  #       run: echo "Testing compatibility..."
