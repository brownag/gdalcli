# Build Release for GDAL Version
#
# Manual workflow dispatch to build gdalcli for a specific GDAL version.
# Compiles GDAL from source using Docker, generates API, runs tests.
#
# Testing/Debugging Strategy:
# - On any branch: Workflow runs, generates API, creates release branch, but DOES NOT create tag
# - On main branch: Workflow runs and creates official GitHub release + tag (if create_release='true')
# - To test: Dispatch from a feature branch, iterate on fixes, then merge to main for official release
#
name: Build Release for GDAL Version

on:
  workflow_dispatch:
    inputs:
      gdal_version:
        description: 'GDAL version (e.g., 3.11.4, 3.12.1)'
        required: true
      create_release:
        description: 'Create GitHub release and tag? (only effective on main branch)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      gdal_version: ${{ steps.parse.outputs.gdal_version }}
      gdal_short: ${{ steps.parse.outputs.gdal_short }}
      branch_name: ${{ steps.parse.outputs.branch_name }}
      tag_name: ${{ steps.parse.outputs.tag_name }}
    steps:
      - name: Validate and parse GDAL version
        id: parse
        run: |
          VERSION="${{ github.event.inputs.gdal_version }}"

          # Validate semver format (X.Y.Z)
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Invalid version format: $VERSION (expected X.Y.Z)"
            exit 1
          fi

          # Extract major.minor
          SHORT=$(echo "$VERSION" | cut -d. -f1-2)

          # Validate >= 3.11
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)

          if (( MAJOR < 3 )) || (( MAJOR == 3 && MINOR < 11 )); then
            echo "ERROR: GDAL version must be >= 3.11 (got $VERSION)"
            exit 1
          fi

          BRANCH="release/gdal-${SHORT}"
          TAG="v0.2.0-gdal-${VERSION}"

          echo "gdal_version=$VERSION" >> $GITHUB_OUTPUT
          echo "gdal_short=$SHORT" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG" >> $GITHUB_OUTPUT

          echo "Validated GDAL $VERSION"
          echo "  Branch: $BRANCH"
          echo "  Tag: $TAG"

  build:
    needs: validate
    runs-on: ubuntu-24.04-8core
    timeout-minutes: 120
    permissions:
      contents: write

    steps:
      - name: Checkout feedstock
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for GDAL ${{ needs.validate.outputs.gdal_version }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .github/dockerfiles/Dockerfile.template
          target: base
          build-args: |
            GDAL_VERSION=${{ needs.validate.outputs.gdal_version }}
            GDAL_RELEASE_TYPE=tagged
          tags: |
            gdalcli:gdal-${{ needs.validate.outputs.gdal_short }}-dev
          cache-from: type=gha,scope=gdal-${{ needs.validate.outputs.gdal_version }}
          cache-to: type=gha,mode=max,scope=gdal-${{ needs.validate.outputs.gdal_version }}
          load: true
          build-contexts: |
            context=.github/dockerfiles

      - name: Show build progress
        run: |
          echo "Docker build started at $(date)"
          echo "Building GDAL ${{ needs.validate.outputs.gdal_version }} with 8 cores"
          echo "Monitor progress with: docker buildx ls && docker buildx logs"

      - name: Extract generated API from Docker image
        run: |
          # Create container and extract generated R files
          CONTAINER=$(docker create gdalcli:gdal-${{ needs.validate.outputs.gdal_short }}-dev)
          docker cp $CONTAINER:/workspace/gdalcli/R . || docker cp $CONTAINER:/workspace/gdalcli/man . || true
          docker rm $CONTAINER

          # Verify API was generated
          if [ ! -d "R" ] || [ -z "$(ls -A R/*.R 2>/dev/null | grep -v '^R/aaa' | grep -v '^R/zzz' | head -5)" ]; then
            echo "ERROR: No API generated in Docker image"
            exit 1
          fi

          echo "Generated API files:"
          ls -la R/gdal_*.R | head -20

      - name: Update DESCRIPTION
        run: |
          GDAL_VERSION="${{ needs.validate.outputs.gdal_version }}"
          GDAL_SHORT="${{ needs.validate.outputs.gdal_short }}"

          # Update Version field
          sed -i "s/^Version:.*/Version: 0.2.0+gdal-${GDAL_SHORT}/" DESCRIPTION

          # Update SystemRequirements field
          sed -i "s/^SystemRequirements:.*/SystemRequirements: GDAL (>= ${GDAL_VERSION})/" DESCRIPTION

          cat DESCRIPTION | grep -E "^Version:|^SystemRequirements:"

      - name: Set up R for local checks
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'latest'

      - name: Install R dependencies
        run: |
          install.packages(c("devtools", "roxygen2", "testthat", "remotes"))
          remotes::install_deps(dependencies = TRUE)
        shell: Rscript {0}

      - name: Build and check package
        run: |
          devtools::document()
          devtools::check(error_on = "warning")
        shell: Rscript {0}

      - name: Configure git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create release branch
        if: success()
        run: |
          BRANCH="${{ needs.validate.outputs.branch_name }}"
          GDAL_VERSION="${{ needs.validate.outputs.gdal_version }}"

          # Check if branch exists
          if git rev-parse --verify origin/$BRANCH 2>/dev/null; then
            git checkout -b $BRANCH origin/$BRANCH
            git reset --hard main
          else
            git checkout -b $BRANCH main
          fi

          # Commit changes if any
          git add DESCRIPTION
          if ! git diff --cached --quiet; then
            git commit -m "Release: GDAL $GDAL_VERSION (API generated, checks passed)"
          fi

          # Push branch
          git push origin $BRANCH --force
          echo "Created/updated branch: $BRANCH"

      - name: Create GitHub release
        if: success() && github.event.inputs.create_release == 'true' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.tag_name }}
          target_commitish: ${{ needs.validate.outputs.branch_name }}
          name: gdalcli for GDAL ${{ needs.validate.outputs.gdal_version }}
          draft: false
          prerelease: false
          body: |
            Release of gdalcli for GDAL ${{ needs.validate.outputs.gdal_version }}

            ## Details
            - GDAL Version: ${{ needs.validate.outputs.gdal_version }}
            - Release Branch: ${{ needs.validate.outputs.branch_name }}
            - R Package Version: 0.2.0+gdal-${{ needs.validate.outputs.gdal_short }}

            ## Installation
            From release branch:
            ```r
            remotes::install_github(
              "brownag/gdalcli",
              ref = "${{ needs.validate.outputs.branch_name }}"
            )
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: always()
        run: |
          RELEASE_INFO="❌ No (not on main branch)"
          if [ "${{ github.ref }}" = "refs/heads/main" ] && [ "${{ github.event.inputs.create_release }}" = "true" ]; then
            RELEASE_INFO="✓ Yes (${{ needs.validate.outputs.tag_name }})"
          elif [ "${{ github.ref }}" != "refs/heads/main" ]; then
            RELEASE_INFO="❌ No (test branch - tag only created on main)"
          fi

          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          ## Build Summary

          | Item | Value |
          |------|-------|
          | GDAL Version | ${{ needs.validate.outputs.gdal_version }} |
          | Release Branch | `${{ needs.validate.outputs.branch_name }}` |
          | Build Status | ${{ job.status }} |
          | GitHub Release Tag | ${RELEASE_INFO} |
          EOF
