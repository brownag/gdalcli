---
# Build Release for GDAL Version
#
# Manual workflow dispatch to build gdalcli for a specific GDAL version.
# Compiles GDAL from source using Docker, generates API, runs tests.
#
# Testing/Debugging Strategy:
# - On any branch: Workflow runs, generates API, creates release branch,
#   but DOES NOT create tag
# - On main branch: Workflow runs and creates official GitHub release + tag
#   (if create_release='true')
# - To test: Dispatch from a feature branch, iterate on fixes, then merge
#   to main for official release
#
name: Build Release for GDAL Version

on:
  workflow_dispatch:
    inputs:
      gdal_version:
        description: |
          GDAL version (e.g., 3.11.4, 3.12.0) or "latest" for most recent
          stable release
        required: true
      gdal_build_mode:
        description: |
          GDAL build mode: osgeo (use pre-built OSGeo images), source
          (compile from source), or prebuilt (use pre-built gdalcli base images)
        required: true
        default: 'osgeo'
        type: choice
        options:
          - 'osgeo'
          - 'source'
          - 'prebuilt'
      package_version:
        description: 'Base package version (e.g., 0.2.0)'
        required: true
        default: '0.2.0'
      create_release:
        description: 'Create GitHub release and tag? (only effective on main branch)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      architecture:
        description: |
          Target architecture: amd64 (x86_64) or arm64. For OSGeo builds,
          arm64 should work as drop-in replacement. For source builds,
          arm64 compilation will be slower and less tested.
        required: true
        default: 'amd64'
        type: choice
        options:
          - 'amd64'
          - 'arm64'

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      gdal_version: ${{ steps.parse.outputs.gdal_version }}
      gdal_short: ${{ steps.parse.outputs.gdal_short }}
      branch_name: ${{ steps.parse.outputs.branch_name }}
      tag_name: ${{ steps.parse.outputs.tag_name }}
      gdal_image_tag: ${{ steps.check-image.outputs.selected_gdal_image_tag }}
    steps:
      - name: Validate and parse GDAL version
        id: parse
        run: |
          VERSION="${{ github.event.inputs.gdal_version }}"

          # Handle "latest" special case
          if [ "$VERSION" = "latest" ]; then
            echo "Fetching latest GDAL version..."
            LATEST_VERSION=$(curl -fsSL https://api.github.com/repos/OSGeo/gdal/releases/latest | jq -r '.tag_name' | sed 's/^v//')
            if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
              echo "ERROR: Failed to fetch latest GDAL version"
              exit 1
            fi
            echo "Latest GDAL version: $LATEST_VERSION"
            VERSION="$LATEST_VERSION"
          fi

          # Validate semver format (X.Y.Z) or "latest"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Invalid version format: $VERSION (expected X.Y.Z)"
            exit 1
          fi

          # Extract major.minor
          SHORT=$(echo "$VERSION" | cut -d. -f1-2)

          # Validate >= 3.11
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)

          if (( MAJOR < 3 )) || (( MAJOR == 3 && MINOR < 11 )); then
            echo "ERROR: GDAL version must be >= 3.11 (got $VERSION)"
            exit 1
          fi

          BRANCH="release/gdal-${SHORT}"
          TAG="v0.2.0-gdal-${VERSION}"

          echo "gdal_version=$VERSION" >> $GITHUB_OUTPUT
          echo "gdal_short=$SHORT" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG" >> $GITHUB_OUTPUT

          echo "Validated GDAL $VERSION"
          echo "  Branch: $BRANCH"
          echo "  Tag: $TAG"

      - name: Check OSGeo GDAL image availability
        id: check-image
        if: github.event.inputs.gdal_build_mode == 'osgeo'
        run: |
          GDAL_VERSION="${{ steps.parse.outputs.gdal_version }}"
          ARCH="${{ github.event.inputs.architecture }}"

          # Try different tag formats in order of preference
          if [ "$ARCH" = "arm64" ]; then
            TAGS_TO_TRY=(
              "ubuntu-small-arm64-${GDAL_VERSION}"
              "ubuntu-small-${GDAL_VERSION}"
              "ubuntu-small-arm64-latest"
              "ubuntu-small-latest"
              "ubuntu-small-arm64"
              "ubuntu-small"
              "latest"
            )
          else
            TAGS_TO_TRY=(
              "ubuntu-small-amd64-${GDAL_VERSION}"
              "ubuntu-small-${GDAL_VERSION}"
              "ubuntu-small-amd64-latest"
              "ubuntu-small-latest"
              "ubuntu-small-amd64"
              "ubuntu-small"
              "latest"
            )
          fi

          SELECTED_TAG=""
          for TAG in "${TAGS_TO_TRY[@]}"; do
            IMAGE_TAG="ghcr.io/osgeo/gdal:${TAG}"
            echo "Checking: $IMAGE_TAG"

            if docker buildx imagetools inspect "$IMAGE_TAG" >/dev/null 2>&1; then
              echo "Found OSGeo GDAL image: $IMAGE_TAG"
              SELECTED_TAG="$TAG"
              break
            fi
          done

          if [ -z "$SELECTED_TAG" ]; then
            echo "No suitable OSGeo GDAL image found for version ${GDAL_VERSION} (${ARCH})"
            exit 1
          fi

          echo "selected_gdal_image_tag=$SELECTED_TAG" >> $GITHUB_OUTPUT

      - name: Set default image tag for source builds
        id: set-default-tag
        if: github.event.inputs.gdal_build_mode == 'source'
        run: |
          ARCH="${{ github.event.inputs.architecture }}"
          if [ "$ARCH" = "arm64" ]; then
            echo "selected_gdal_image_tag=ubuntu-small-arm64-${{ steps.parse.outputs.gdal_version }}" >> $GITHUB_OUTPUT
          else
            echo "selected_gdal_image_tag=ubuntu-small-amd64-${{ steps.parse.outputs.gdal_version }}" >> $GITHUB_OUTPUT
          fi

      - name: Check pre-built base image availability
        id: check-prebuilt
        if: github.event.inputs.gdal_build_mode == 'prebuilt'
        run: |
          VERSION="${{ steps.parse.outputs.gdal_version }}"
          ARCH="${{ github.event.inputs.architecture }}"
          
          IMAGE_TAG="ghcr.io/brownag/gdalcli:base-gdal-${VERSION}-${ARCH}"
          echo "Checking pre-built base image: $IMAGE_TAG"
          
          if docker buildx imagetools inspect "$IMAGE_TAG" >/dev/null 2>&1; then
            echo "Found pre-built base image: $IMAGE_TAG"
            echo "selected_gdal_image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Pre-built base image not found: $IMAGE_TAG"
            echo "Please run the 'Build GDAL Base Images' workflow first to create this image."
            exit 1
          fi

  build:
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: ${{ github.event.inputs.gdal_build_mode == 'osgeo' && 30 || 60 }}
    permissions:
      contents: write

    steps:
      - name: Checkout feedstock
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check existing cache
        run: |
          echo "Checking for existing Docker cache..."
          docker buildx du --filter scope=gdal-${{ github.event.inputs.gdal_build_mode }}-${{ needs.validate.outputs.gdal_version }} || echo "No base image cache found"

      - name: Build Docker image for GDAL ${{ needs.validate.outputs.gdal_version }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .github/dockerfiles/Dockerfile.template
          target: gdal-base
          build-args: |
            GDAL_BUILD_MODE=${{ github.event.inputs.gdal_build_mode }}
            GDAL_VERSION=${{ needs.validate.outputs.gdal_version }}
            GDAL_RELEASE_TYPE=tagged
            GDAL_IMAGE_TAG=${{ needs.validate.outputs.gdal_image_tag }}
            USE_PREBUILT_BASE=${{ github.event.inputs.gdal_build_mode == 'prebuilt' && 'true' || 'false' }}
            R_VERSION=latest
            PACKAGE_VERSION=${{ github.event.inputs.package_version }}
          tags: |
            gdalcli:gdal-${{ needs.validate.outputs.gdal_short }}-dev
          platforms: linux/${{ github.event.inputs.architecture }}
          cache-from: |
            type=gha,scope=gdal-${{ github.event.inputs.gdal_build_mode }}-${{ needs.validate.outputs.gdal_version }}
          cache-to: |
            type=gha,mode=max,scope=gdal-${{ github.event.inputs.gdal_build_mode }}-${{ needs.validate.outputs.gdal_version }}
          load: true
          build-contexts: |
            context=.github/dockerfiles

      - name: Show build progress and cache status
        run: |
          echo "Docker build started at $(date)"
          echo "Build mode: ${{ github.event.inputs.gdal_build_mode }}"
          echo "Architecture: ${{ github.event.inputs.architecture }}"
          if [ "${{ github.event.inputs.gdal_build_mode }}" = "osgeo" ]; then
            echo "Using OSGeo GDAL ${{ needs.validate.outputs.gdal_version }} image: ${{ needs.validate.outputs.gdal_image_tag }}"
          elif [ "${{ github.event.inputs.gdal_build_mode }}" = "prebuilt" ]; then
            echo "Using pre-built gdalcli base image for GDAL ${{ needs.validate.outputs.gdal_version }}"
          else
            echo "Compiling GDAL ${{ needs.validate.outputs.gdal_version }} from source"
          fi
          echo "Package version: ${{ github.event.inputs.package_version }}"
          echo ""
          if [ "${{ github.event.inputs.gdal_build_mode }}" = "osgeo" ]; then
            echo "Build time: ~5-15 minutes"
          elif [ "${{ github.event.inputs.gdal_build_mode }}" = "prebuilt" ]; then
            echo "Build time: ~2-5 minutes"
          else
            echo "Build time: ~30-45 minutes"
          fi

      - name: Extract generated API from Docker image
        run: |
          # Create container and extract generated R files
          CONTAINER=$(docker create gdalcli:gdal-${{ needs.validate.outputs.gdal_short }}-dev)
          docker cp $CONTAINER:/workspace/gdalcli/R . || docker cp $CONTAINER:/workspace/gdalcli/man . || true
          docker rm $CONTAINER

          # Verify API was generated
          if [ ! -d "R" ] || [ -z "$(ls -A R/*.R 2>/dev/null | grep -v '^R/aaa' | grep -v '^R/zzz' | head -5)" ]; then
            echo "ERROR: No API generated in Docker image"
            exit 1
          fi

          echo "Generated API files:"
          ls -la R/gdal_*.R | head -20

      - name: Update DESCRIPTION
        run: |
          GDAL_VERSION="${{ needs.validate.outputs.gdal_version }}"
          GDAL_SHORT="${{ needs.validate.outputs.gdal_short }}"

          # Update Version field
          sed -i "s/^Version:.*/Version: 0.2.0+gdal-${GDAL_SHORT}/" DESCRIPTION

          # Update SystemRequirements field
          sed -i "s/^SystemRequirements:.*/SystemRequirements: GDAL (>= ${GDAL_VERSION})/" DESCRIPTION

          cat DESCRIPTION | grep -E "^Version:|^SystemRequirements:"

      - name: Set up R for local checks
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'latest'
          use-public-rspm: true

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/R
            ~/R/x86_64-pc-linux-gnu-library
          key: r-packages-${{ runner.os }}-latest-${{ hashFiles('DESCRIPTION') }}
          restore-keys: |
            r-packages-${{ runner.os }}-latest-

      - name: Install system dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            any::devtools
            any::roxygen2
            any::testthat
            any::remotes
          extra-packages: any::rcmdcheck
          needs: check
          cache-version: 1

      - name: Generate GDAL API
        run: |
          Rscript build/generate_gdal_api.R

      - name: Document package
        run: |
          Rscript -e "roxygen2::roxygenise()"

      - name: Run R CMD check
        uses: r-lib/actions/check-r-package@v2
        with:
          build_args: 'c("--no-manual","--compact-vignettes=gs+qpdf")'
          upload-snapshots: true

      - name: Configure git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create release branch
        if: success()
        run: |
          BRANCH="${{ needs.validate.outputs.branch_name }}"
          GDAL_VERSION="${{ needs.validate.outputs.gdal_version }}"

          # Check if branch exists
          if git rev-parse --verify origin/$BRANCH 2>/dev/null; then
            git checkout -b $BRANCH origin/$BRANCH
            git reset --hard main
          else
            git checkout -b $BRANCH main
          fi

          # Commit changes if any
          git add DESCRIPTION
          if ! git diff --cached --quiet; then
            git commit -m "Release: GDAL $GDAL_VERSION (API generated, checks passed)"
          fi

          # Push branch
          git push origin $BRANCH --force
          echo "Created/updated branch: $BRANCH"

      - name: Create GitHub release
        if: success() && github.event.inputs.create_release == 'true' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.tag_name }}
          target_commitish: ${{ needs.validate.outputs.branch_name }}
          name: gdalcli for GDAL ${{ needs.validate.outputs.gdal_version }}
          draft: false
          prerelease: false
          body: |
            Release of gdalcli for GDAL ${{ needs.validate.outputs.gdal_version }}

            ## Details
            - GDAL Version: ${{ needs.validate.outputs.gdal_version }}
            - Build Mode: ${{ github.event.inputs.gdal_build_mode }}
            - Architecture: ${{ github.event.inputs.architecture }}
            - Package Version: ${{ github.event.inputs.package_version }}
            - Release Branch: ${{ needs.validate.outputs.branch_name }}
            - R Package Version: ${{ github.event.inputs.package_version }}+gdal-${{ needs.validate.outputs.gdal_short }}

            ## Installation
            From release branch:
            ```r
            remotes::install_github(
              "brownag/gdalcli",
              ref = "${{ needs.validate.outputs.branch_name }}"
            )
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: always()
        run: |
          RELEASE_INFO="No (not on main branch)"
          if [ "${{ github.ref }}" = "refs/heads/main" ] && [ "${{ github.event.inputs.create_release }}" = "true" ]; then
            RELEASE_INFO="Yes (${{ needs.validate.outputs.tag_name }})"
          fi

          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          ## Build Summary

          | Item | Value |
          |------|-------|
          | GDAL Version | ${{ needs.validate.outputs.gdal_version }} |
          | Build Mode | ${{ github.event.inputs.gdal_build_mode }} |
          | Architecture | ${{ github.event.inputs.architecture }} |
          | Package Version | ${{ github.event.inputs.package_version }} |
          | Release Branch | `${{ needs.validate.outputs.branch_name }}` |
          | Build Status | ${{ job.status }} |
          | GitHub Release | ${RELEASE_INFO} |
          EOF
