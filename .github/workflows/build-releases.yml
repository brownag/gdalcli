---
# Build Release for GDAL Version
#
# Manual workflow dispatch to build gdalcli for a specific GDAL version.
# Generates API, runs tests, and creates release branch and GitHub release.
#
# Strategy:
# - Uses pre-built deps-gdal-X.Y.Z-amd64 images from build-docker-images.yml
# - Builds gdalcli-runtime image with API generation and package tests
# - Creates release branch and GitHub release on main branch
#
name: Build Release for GDAL Version

on:
  workflow_dispatch:
    inputs:
      gdal_version:
        description: |
          GDAL version to build for (e.g., 3.11.4, 3.12.0)
        required: true
      create_release:
        description: 'Create GitHub release and tag? (only effective on main branch)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      dry_run:
        description: 'Dry run mode: skip branch/release creation and image push'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  packages: write

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      gdal_version: ${{ steps.parse.outputs.gdal_version }}
      gdal_short: ${{ steps.parse.outputs.gdal_short }}
      package_version: ${{ steps.parse.outputs.package_version }}
      branch_name: ${{ steps.parse.outputs.branch_name }}
      tag_name: ${{ steps.parse.outputs.tag_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate and parse GDAL version
        id: parse
        run: |
          VERSION="${{ github.event.inputs.gdal_version }}"

          # Validate semver format (X.Y.Z)
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Invalid version format: $VERSION (expected X.Y.Z)"
            exit 1
          fi

          # Extract major.minor
          SHORT=$(echo "$VERSION" | cut -d. -f1-2)

          # Validate >= 3.11
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)

          if (( MAJOR < 3 )) || (( MAJOR == 3 && MINOR < 11 )); then
            echo "ERROR: GDAL version must be >= 3.11 (got $VERSION)"
            exit 1
          fi

          # Extract package version from DESCRIPTION
          PKG_VERSION=$(grep "^Version:" DESCRIPTION | sed 's/Version: //')
          
          if [ -z "$PKG_VERSION" ]; then
            echo "ERROR: Could not extract package version from DESCRIPTION"
            exit 1
          fi

          BRANCH="release/gdal-${SHORT}"
          TAG="v${PKG_VERSION}-${VERSION}"

          echo "gdal_version=$VERSION" >> $GITHUB_OUTPUT
          echo "gdal_short=$SHORT" >> $GITHUB_OUTPUT
          echo "package_version=$PKG_VERSION" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG" >> $GITHUB_OUTPUT

          echo "Validated GDAL $VERSION"
          echo "  Package Version: $PKG_VERSION"
          echo "  Branch: $BRANCH"
          echo "  Tag: $TAG"

      - name: Check deps image availability
        run: |
          VERSION="${{ steps.parse.outputs.gdal_version }}"
          IMAGE="ghcr.io/${{ github.repository }}:deps-gdal-${VERSION}-amd64"
          
          echo "Checking for deps image: $IMAGE"
          
          # Note: docker buildx imagetools requires authentication for private images
          # For now, we'll just verify the image exists by trying to use it in a build
          # The actual build will fail if the image doesn't exist

  build:
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check OSGeo GDAL image availability
        id: check-image
        run: |
          GDAL_VERSION="${{ needs.validate.outputs.gdal_version }}"

          TAGS_TO_TRY=(
            "ubuntu-small-${GDAL_VERSION}-amd64"
            "ubuntu-small-${GDAL_VERSION}"
            "ubuntu-small-latest-amd64"
            "ubuntu-small-latest"
            "ubuntu-small-amd64"
            "ubuntu-small"
            "latest"
          )

          SELECTED_TAG=""
          for TAG in "${TAGS_TO_TRY[@]}"; do
            IMAGE_TAG="ghcr.io/osgeo/gdal:${TAG}"
            echo "Checking: $IMAGE_TAG"

            if docker buildx imagetools inspect "$IMAGE_TAG" >/dev/null 2>&1; then
              echo "Found OSGeo GDAL image: $IMAGE_TAG"
              SELECTED_TAG="$TAG"
              break
            fi
          done

          if [ -z "$SELECTED_TAG" ]; then
            echo "No suitable OSGeo GDAL image found for version ${GDAL_VERSION}"
            exit 1
          fi

          echo "selected_gdal_image_tag=$SELECTED_TAG" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build runtime image for GDAL ${{ needs.validate.outputs.gdal_version }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .github/dockerfiles/Dockerfile.template
          target: gdalcli-runtime
          build-args: |
            GDAL_BUILD_MODE=osgeo
            GDAL_VERSION=${{ needs.validate.outputs.gdal_version }}
            GDAL_RELEASE_TYPE=tagged
            GDAL_IMAGE_TAG=${{ steps.check-image.outputs.selected_gdal_image_tag }}
            R_VERSION=latest
            PACKAGE_VERSION=${{ needs.validate.outputs.package_version }}
          tags: |
            ghcr.io/${{ github.repository }}:gdal-${{ needs.validate.outputs.gdal_version }}-latest
          platforms: linux/amd64
          cache-from: type=gha,scope=release-${{ needs.validate.outputs.gdal_version }}
          cache-to: type=gha,mode=max,scope=release-${{ needs.validate.outputs.gdal_version }}
          push: ${{ github.event.inputs.dry_run == 'false' }}
          build-contexts: context=.github/dockerfiles

      - name: Create GDAL_VERSION_INFO.json
        run: |
          GDAL_VERSION="${{ needs.validate.outputs.gdal_version }}"
          BUILD_DATE="$(date -I)"
          GENERATED_AT="$(date '+%Y-%m-%d %H:%M:%S')"
          
          # Parse version components
          MAJOR=$(echo "$GDAL_VERSION" | cut -d. -f1)
          MINOR=$(echo "$GDAL_VERSION" | cut -d. -f2)
          PATCH=$(echo "$GDAL_VERSION" | cut -d. -f3)
          
          cat > inst/GDAL_VERSION_INFO.json <<EOF
          {
            "generated_at": "$GENERATED_AT",
            "gdal_version": "$GDAL_VERSION",
            "gdal_version_parsed": {
              "full": "$GDAL_VERSION",
              "major": $MAJOR,
              "minor": $MINOR,
              "patch": $PATCH
            },
            "generation_date": "$BUILD_DATE",
            "r_version": "$(R --version | head -1 | sed 's/R version \([0-9.]*\).*/\1/')",
            "packages": {
              "processx": "$(R -e "cat(as.character(packageVersion('processx')))" 2>/dev/null || echo "unknown")",
              "jsonlite": "$(R -e "cat(as.character(packageVersion('jsonlite')))" 2>/dev/null || echo "unknown")"
            }
          }
          EOF
          cat inst/GDAL_VERSION_INFO.json

      - name: Configure git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create and reset release branch
        if: github.event.inputs.dry_run == 'false'
        run: |
          BRANCH="${{ needs.validate.outputs.branch_name }}"

          # Fetch latest main
          git fetch origin main

          # Create or reset branch to main
          if git rev-parse --verify origin/$BRANCH 2>/dev/null; then
            git checkout -b $BRANCH origin/$BRANCH
            git reset --hard origin/main
          else
            git checkout -b $BRANCH origin/main
          fi

      - name: Update DESCRIPTION
        run: |
          GDAL_VERSION="${{ needs.validate.outputs.gdal_version }}"
          PKG_VERSION="${{ needs.validate.outputs.package_version }}"

          # Update Version field with GDAL suffix
          sed -i "s/^Version:.*/Version: ${PKG_VERSION}-${GDAL_VERSION}/" DESCRIPTION

          # Update SystemRequirements field
          sed -i "s/^SystemRequirements:.*/SystemRequirements: GDAL (>= ${GDAL_VERSION})/" DESCRIPTION

          cat DESCRIPTION | grep -E "^Version:|^SystemRequirements:"

      - name: Set up R for local checks
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'latest'
          use-public-rspm: true

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/R
            ~/R/x86_64-pc-linux-gnu-library
          key: r-packages-${{ runner.os }}-latest-${{ hashFiles('DESCRIPTION') }}
          restore-keys: |
            r-packages-${{ runner.os }}-latest-

      - name: Install system dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            any::devtools
            any::roxygen2
            any::testthat
            any::remotes
            any::knitr
            any::rmarkdown
          extra-packages: any::rcmdcheck
          needs: check
          cache-version: 1

      - name: Generate GDAL API
        run: |
          Rscript build/generate_gdal_api.R

      - name: Document package
        run: |
          Rscript -e "roxygen2::roxygenise()"

      - name: Run R CMD check
        uses: r-lib/actions/check-r-package@v2
        with:
          build_args: 'c("--no-manual","--compact-vignettes=gs+qpdf")'
          upload-snapshots: true

      - name: Configure git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create release branch
        if: success() && github.event.inputs.dry_run == 'false'
        run: |
          BRANCH="${{ needs.validate.outputs.branch_name }}"
          GDAL_VERSION="${{ needs.validate.outputs.gdal_version }}"

          # Stage and commit changes if any
          git add DESCRIPTION
          git add -f inst/GDAL_VERSION_INFO.json
          
          # Add auto-generated files from API generation and documentation
          git add R/
          git add man/
          git add NAMESPACE
          
          if ! git diff --cached --quiet; then
            git commit -m "Release: gdalcli for GDAL $GDAL_VERSION"
          fi

          # Push branch
          git push origin $BRANCH --force
          echo "Created/updated branch: $BRANCH"

      - name: Create GitHub release
        if: success() && github.event.inputs.create_release == 'true' && github.ref == 'refs/heads/main' && github.event.inputs.dry_run == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.tag_name }}
          target_commitish: ${{ needs.validate.outputs.branch_name }}
          name: gdalcli for GDAL ${{ needs.validate.outputs.gdal_version }}
          draft: false
          prerelease: false
          body: |
            Release of gdalcli for GDAL ${{ needs.validate.outputs.gdal_version }}

            ## Details
            - GDAL Version: ${{ needs.validate.outputs.gdal_version }}
            - Package Version: ${{ needs.validate.outputs.package_version }}-${{ needs.validate.outputs.gdal_version }}
            - Release Branch: `${{ needs.validate.outputs.branch_name }}`
            - Docker Image: `ghcr.io/${{ github.repository }}:gdal-${{ needs.validate.outputs.gdal_version }}-latest`

            ## Installation
            Install from release branch:
            ```r
            remotes::install_github(
              "brownag/gdalcli",
              ref = "${{ needs.validate.outputs.branch_name }}"
            )
            ```

            Pull runtime Docker image:
            ```bash
            docker pull ghcr.io/${{ github.repository }}:gdal-${{ needs.validate.outputs.gdal_version }}-latest
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        if: always()
        run: |
          RELEASE_INFO="No (not on main branch)"
          if [ "${{ github.ref }}" = "refs/heads/main" ] && [ "${{ github.event.inputs.create_release }}" = "true" ]; then
            RELEASE_INFO="Yes (${{ needs.validate.outputs.tag_name }})"
          fi

          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          ## Build Summary

          | Item | Value |
          |------|-------|
          | GDAL Version | ${{ needs.validate.outputs.gdal_version }} |
          | Package Version | ${{ needs.validate.outputs.package_version }}-${{ needs.validate.outputs.gdal_version }} |
          | Release Branch | `${{ needs.validate.outputs.branch_name }}` |
          | Docker Image | `ghcr.io/${{ github.repository }}:gdal-${{ needs.validate.outputs.gdal_version }}-latest` |
          | Build Status | ${{ job.status }} |
          | GitHub Release | ${RELEASE_INFO} |
          | Dry Run | ${{ github.event.inputs.dry_run }} |
          EOF
